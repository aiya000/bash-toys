#!/bin/bash

# A basic CLI pomodoro timer implementation in shell script.
#
# Example:
# ```bash
# # Notify end of pomodoro with sound after 30 mins.
# # The sound is $BASH_TOYS_POMODORO_NOTIFICATION_MUSIC.
# $ pomodoro-timer
#
# # You can specify pomodoro time count. e.g., below specifies 60 mins.
# $ pomodoro-timer 60
#
# # Start timer from a specific time (e.g., start from 20:45 for 60 mins)
# $ pomodoro-timer --from 20:45 60
#
# # Resume previous pomodoro-timer from history (automatically detects start time and duration)
# $ pomodoro-timer --resume
#
# # Start timer from a specific date and time
# $ pomodoro-timer --from '2025-09-24 23:50' 60
#
# # Notify end of pomodoro rest time silently after 5 mins.
# $ pomodoro-timer --rest
#
# # Same as above, you can specify podoro rest time count.
# $ pomodoro-timer --rest 10
#
# # Clean pomodoro count
# $ pomodoro-timer --clean
#
# # Set current pomodoro count
# $ pomodoro-timer --set-count 3
# $ ls /tmp/pomodoro-3
# /tmp/pomodoro-3
#
# # Get current pomodoro count
# $ pomodoro-timer --get-count
# ```

if [[ $1 == --set-count ]] ; then
  if [[ $2 == '' ]] ; then
    echo '--set-count requires minutes as a second argument' > /dev/stderr
    exit 1
  fi

  this_script=$0
  $this_script --clean > /dev/null
  touch "/tmp/pomodoro-$2"
  echo "The current pomodoro count is $2"
  exit
fi

if [[ $1 == --resume ]] ; then
  # Check if rg is available, fallback to grep
  if command -v rg &> /dev/null ; then
    grep_cmd="rg"
  else
    grep_cmd="grep"
  fi

  # Use appropriate history command based on shell
  # zsh: fc -li 1
  # bash: history
  if [[ -n $ZSH_VERSION ]] ; then
    history_cmd="fc -li 1"
  else
    history_cmd="history"
  fi

  # Find available interactive filter
  interactive_filter=""
  if [[ -n $BASH_TOYS_INTERACTIVE_FILTER ]] && command -v "$BASH_TOYS_INTERACTIVE_FILTER" &> /dev/null ; then
    interactive_filter="$BASH_TOYS_INTERACTIVE_FILTER"
  elif command -v peco &> /dev/null ; then
    interactive_filter="peco"
  elif command -v fzf &> /dev/null ; then
    interactive_filter="fzf"
  elif command -v percol &> /dev/null ; then
    interactive_filter="percol"
  elif command -v sk &> /dev/null ; then
    interactive_filter="sk"
  else
    echo 'No interactive filter found. Please install one of: peco, fzf, percol, sk' > /dev/stderr
    echo 'Or set BASH_TOYS_INTERACTIVE_FILTER to your preferred filter' > /dev/stderr
    exit 1
  fi

  # Get recent pomodoro-timer commands from history
  history_size="${BASH_TOYS_POMODORO_RESUME_HISTORY_SIZE:-10}"
  history_candidates=$(eval "$history_cmd" | $grep_cmd pomodoro-timer | $grep_cmd -v -- --resume | $grep_cmd -v "$grep_cmd" | tail -"$history_size")

  if [[ -z $history_candidates ]] ; then
    echo 'No previous pomodoro-timer execution found in history' > /dev/stderr
    exit 1
  fi

  # Let user select which command to resume
  selected_command=$(echo "$history_candidates" | "$interactive_filter")

  if [[ -z $selected_command ]] ; then
    echo 'No command selected' > /dev/stderr
    exit 1
  fi

  # Extract time - handle both formats:
  # zsh (fc -li 1): "13430  2025-10-09 04:46  pomodoro-timer 60"
  # bash (history): "  123  12:34  pomodoro-timer 60"
  # Check if field 2 contains a date (YYYY-MM-DD format)
  if echo "$selected_command" | awk '{print $2}' | $grep_cmd -q '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$' ; then
    # zsh format: time is in field 3
    start_time=$(echo "$selected_command" | awk '{print $3}')
  else
    # bash format: time is in field 2
    start_time=$(echo "$selected_command" | awk '{print $2}')
  fi

  # Extract all arguments after pomodoro-timer command
  # This handles both "pomodoro-timer 60" and "pomodoro-timer --rest 10" cases
  args=$(echo "$selected_command" | sed 's/.*pomodoro-timer //')

  if [[ -z $start_time ]] ; then
    echo 'Could not extract time from history' > /dev/stderr
    echo "Selected command: $selected_command" > /dev/stderr
    exit 1
  fi

  # Check if it was a regular timer or rest timer
  if echo "$args" | $grep_cmd -q -- --rest ; then
    # Rest timer case
    rest_duration=$(echo "$args" | sed 's/--rest *//')
    if [[ -z $rest_duration ]] ; then
      rest_duration=5  # Default rest duration
    fi
    echo "Resuming rest timer from $start_time for $rest_duration minutes"
    set -- --from "$start_time" "$rest_duration"
  else
    # Regular timer case
    duration=$(echo "$args" | awk '{print $1}')
    if [[ -z $duration ]] ; then
      duration=30  # Default duration
    fi
    echo "Resuming work timer from $start_time for $duration minutes"
    set -- --from "$start_time" "$duration"
  fi
fi

if [[ $1 == --from ]] ; then
  if [[ $2 == '' ]] ; then
    echo '--from requires start time as a second argument (e.g., 20:45)' > /dev/stderr
    exit 1
  fi
  if [[ $3 == '' ]] ; then
    echo '--from requires duration in minutes as a third argument' > /dev/stderr
    exit 1
  fi

  dir=$(dirname "$0")
  from=$2
  count=$3

  # Detect format and generate appropriate current time
  if [[ $from =~ ^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] ]] ; then
    # Full date format: YYYY-MM-DD HH:MM
    to=$(date +'%Y-%m-%d %H:%M')
  else
    # Time only format: HH:MM
    to=$(date +'%H:%M')
  fi

  consumed_minutes=$("$dir/date-diff-seconds" "$from" "$to")

  # Calculate remaining time in minutes
  remaining_time=$((count - consumed_minutes))

  if [[ $remaining_time -le 0 ]] ; then
    echo "Timer has already expired. Started at $from for $count minutes." > /dev/stderr
    exit 1
  fi

  # Shift arguments to make the remaining code work with the calculated time
  set -- "$remaining_time"
fi

function read_count_file () {
  local result
  result=$(eval 'ls /tmp/pomodoro-*' 2> /dev/null)
  if [[ $result == '' ]] ; then
    echo 0
  else
    # shellcheck disable=SC2001
    echo "$result" | sed 's;^/tmp/pomodoro-;;'
  fi
}
current_count=$(( $(read_count_file) + 1 )) # +1 converts count to human readable count

if [[ $1 == --get-count ]] ; then
  echo "$current_count"
  exit
fi

if [[ $1 == --clean ]] ; then
  if [[ $current_count -eq 1 ]] ; then
    echo 'Pomodoro count has not started yet. (Nothing to do)'
    exit 1
  fi

  eval 'rm /tmp/pomodoro-*' 2> /dev/null
  echo "Removed: /tmp/pomodoro-$current_count"
  exit
fi

is_rest_time=false
interval=30
if [[ $1 == --rest ]] ; then
  is_rest_time=true
  if [[ -n $2 ]] ; then
    interval=$2
  else
    interval=5
  fi
elif [[ -n $1 ]] ; then
  interval=$1
fi

function increase_count_file () {
  local count
  count=$(read_count_file)

  rm "/tmp/pomodoro-$count" 2> /dev/null
  touch "/tmp/pomodoro-$((count + 1))"
}

if [[ $is_rest_time == true ]] ; then
  echo '> Starting break time'
else
  echo "> Starting $current_count-th work time"
fi

for (( minutes = 0; minutes < "$interval"; minutes++ )) ; do
  echo "> $((minutes + 1)) minutes / $interval"
  sleep 1m
done

echo "> $(date)"

if [[ $is_rest_time == true ]] ; then
  echo $'> Now it\'s time to get to work'
else
  echo "> The $current_count-th work hour is over"
  increase_count_file
fi

$BASH_TOYS_MUSIC_PLAYER "$BASH_TOYS_MUSIC_PLAYER_OPTIONS" "$BASH_TOYS_POMODORO_NOTIFICATION_MUSIC" 2> /dev/null &

player_pid=$!
(
  sleep "$BASH_TOYS_POMODORO_NOTIFICATION_DURATION"
  kill "$player_pid" 2> /dev/null
) &

# https://github.com/aiya000/bash-toys
#
# The MIT License (MIT)
#
# Copyright (c) 2025- aiya000
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
