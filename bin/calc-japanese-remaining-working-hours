#!/usr/bin/env -S deno run --allow-net

// See ../doc/bin.md for description

async function getJapaneseHolidays(year: number, month: number): Promise<Set<string>> {
  try {
    const url = `https://holidays-jp.github.io/api/v1/${year}/date.json`;
    const response = await fetch(url);
    if (!response.ok) return new Set();

    const holidays = await response.json();
    const monthStr = month.toString().padStart(2, '0');
    const prefix = `${year}-${monthStr}-`;

    return new Set(
      Object.keys(holidays).filter(date => date.startsWith(prefix))
    );
  } catch {
    return new Set();
  }
}

function isWeekend(date: Date): boolean {
  const day = date.getDay();
  return day === 0 || day === 6; // Sunday or Saturday
}

function showHelp() {
  console.log(`calc-japanese-remaining-working-hours - Calculate required daily working hours

Usage:
  calc-japanese-remaining-working-hours HOURS:MINUTES
  calc-japanese-remaining-working-hours HOURS時間[MINUTES分]
  calc-japanese-remaining-working-hours -h | --help

Arguments:
  HOURS:MINUTES         Remaining working hours for the month (e.g., 108:37)
  HOURS時間[MINUTES分]  Remaining working hours in Japanese format (e.g., 108時間37分)

Options:
  -h, --help      Show this help message

Description:
  Calculates required daily working hours for remaining business days
  in the current month. Automatically fetches Japanese holidays.

Examples:
  calc-japanese-remaining-working-hours 108:37
  calc-japanese-remaining-working-hours 80:00
  calc-japanese-remaining-working-hours 108時間37分
  calc-japanese-remaining-working-hours 51時間
  calc-japanese-remaining-working-hours 51時間30分`);
}

async function main() {
  if (Deno.args.length === 1 && (Deno.args[0] === "--help" || Deno.args[0] === "-h")) {
    showHelp();
    Deno.exit(0);
  }

  if (Deno.args.length !== 1) {
    console.error("Usage: calc-japanese-remaining-working-hours HOURS:MINUTES");
    console.error("       calc-japanese-remaining-working-hours HOURS時間[MINUTES分]");
    console.error("Example: calc-japanese-remaining-working-hours 108:37");
    console.error("         calc-japanese-remaining-working-hours 108時間37分");
    console.error("Use -h or --help for more information.");
    Deno.exit(1);
  }

  // Parse input
  let hours: number;
  let minutes: number;

  const input = Deno.args[0];
  const japaneseMatch = input.match(/^(\d+)時間(?:(\d+)分)?$/);
  const colonMatch = input.match(/^(\d+):(\d+)$/);

  if (japaneseMatch) {
    hours = parseInt(japaneseMatch[1], 10);
    minutes = japaneseMatch[2] !== undefined ? parseInt(japaneseMatch[2], 10) : 0;
  } else if (colonMatch) {
    hours = parseInt(colonMatch[1], 10);
    minutes = parseInt(colonMatch[2], 10);
  } else {
    console.error("Error: Invalid format. Use HOURS:MINUTES (e.g., 108:37) or HOURS時間MINUTES分 (e.g., 108時間37分)");
    Deno.exit(1);
  }

  const totalMinutes = hours * 60 + minutes;

  // Calculate remaining business days
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const lastDay = new Date(year, month, 0).getDate();

  // Fetch holidays
  const holidays = await getJapaneseHolidays(year, month);

  let remainingDays = 0;
  for (let day = now.getDate() + 1; day <= lastDay; day++) {
    const date = new Date(year, month - 1, day);
    const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

    if (isWeekend(date)) continue;
    if (holidays.has(dateStr)) continue;

    remainingDays++;
  }

  if (remainingDays === 0) {
    console.log("今月の営業日は残っていません");
    Deno.exit(0);
  }

  // Calculate per day
  const hoursPerDay = totalMinutes / remainingDays / 60;
  const hoursInt = Math.floor(hoursPerDay);
  const minutesInt = Math.floor((hoursPerDay % 1) * 60);

  console.log(`今月の残り営業日数: ${remainingDays}日`);
  console.log(`残り勤務時間: ${hours}時間${minutes}分 = ${totalMinutes}分`);
  console.log(`1日あたりの必要勤務時間: ${hoursPerDay.toFixed(2)}時間`);
  console.log(`  = ${hoursInt}時間${minutesInt}分`);
}

main();

// vim:set filetype=typescript :
