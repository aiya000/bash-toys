#!/bin/bash

# A basic CLI pomodoro timer implementation in shell script.
#
# Example
#
# # Notify end of pomodoro with sound after 60 mins.
# # The sound is $BASH_TOYS_POMODORO_NOTIFICATION_MUSIC.
# $ pomodoro-start 60
#
# # Notify end of pomodoro rest time silently after 5 mins.
# $ pomodoro-start --rest

is_rest_time=false
interval=30

if [[ $1 = --rest ]] ; then
  is_rest_time=true
  interval=5
elif [[ -n $1 ]] ; then
  interval=$1
fi

function read_count () {
  ( \
    find /tmp/ 2> /dev/null \
    | grep -Eo '/tmp/pomodoro-([0-9]+)' \
    || echo '/tmp/pomodoro-0' \
  ) \
  | sed -r 's;/tmp/pomodoro-([0-9]+);\1;'
}

function increase_count () {
  local count
  count=$(read_count)

  rm "/tmp/pomodoro-$count" 2> /dev/null
  touch "/tmp/pomodoro-$((count + 1))"
}

function get_notification_sound () {
  if [[ -f $DOTFILES_SH_POMODORO_NOTIFY_SOUND ]] ; then
    echo "$DOTFILES_SH_POMODORO_NOTIFY_SOUND"
  elif command -v wsl.exe > /dev/null ; then
    wslpath -m ~/Windows/Music/notify.mp3
  else
    echo ~/.dotfiles/Music/notify.mp3
  fi
}

count=$(( $(read_count) + 1 )) # `+ 1` to count by 1 based

if [[ $is_rest_time = true ]] ; then
  echo $'It\'s time to rest. Good job!'
else
  echo "Let's start $count-th working"
fi

for (( minutes = 0; minutes < "$interval"; minutes++ )) ; do
  echo "$((minutes + 1)) minutes / $interval"
  sleep 1m
done

date

if [[ $is_rest_time = true ]] ; then
  echo $'Let\'s do work :D'
else
  echo "$count-th working time finished!"
  increase_count
fi

$BASH_TOYS_MUSIC_PLAYER "$BASH_TOYS_POMODORO_NOTIFICATION_MUSIC" &
